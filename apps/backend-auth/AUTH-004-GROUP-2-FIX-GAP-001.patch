# AUTH-004 GROUP 2 - FIX GAP-001: Add GDPR Export Permission to Receptionist

**Gap ID**: GAP-001
**Severity**: HIGH
**Module**: Clinical
**Affected Role**: Receptionist
**Issue**: Receptionist cannot fulfill GDPR Article 15 data export requests

---

## Change Required

**File**: `/apps/backend-auth/src/modules/rbac/constants/role-permissions.ts`

**Change Type**: Add permission to role permission set

---

## PATCH

```diff
/* ============================================================================
 * RECEPTIONIST - Front desk and scheduling
 * ============================================================================ */

const RECEPTIONIST_PERMISSIONS: RolePermissionSet = {
  role: SYSTEM_ROLES.RECEPTIONIST,
  permissions: [
    // ===== SCHEDULING: Full appointment management =====
    PERMISSIONS.SCHEDULING.APPOINTMENT.MANAGE,

    // ===== CLINICAL: Read-only patient information =====
    PERMISSIONS.CLINICAL.CHART.READ, // Demographics and basic info only (enforced by field-level access)
    PERMISSIONS.CLINICAL.TREATMENT.READ, // For scheduling context
    PERMISSIONS.CLINICAL.TREATMENT.LIST,
+   PERMISSIONS.CLINICAL.RECORDS.EXPORT, // GDPR Article 15 data portability compliance

    // ===== BILLING: Basic billing operations =====
    PERMISSIONS.BILLING.INVOICE.CREATE,
    PERMISSIONS.BILLING.INVOICE.READ,
    PERMISSIONS.BILLING.INVOICE.LIST,
    PERMISSIONS.BILLING.PAYMENT.CREATE,
    PERMISSIONS.BILLING.PAYMENT.READ,
    PERMISSIONS.BILLING.PAYMENT.LIST,

    // ===== INVENTORY: View availability =====
    PERMISSIONS.INVENTORY.ITEM.READ,
    PERMISSIONS.INVENTORY.ITEM.LIST,
    PERMISSIONS.INVENTORY.STOCK.VIEW,
  ],
  description:
-   'Manages patient scheduling, check-in/out, and basic billing. ' +
-   'Has limited clinical access (demographics only) and cannot process refunds or modify treatment.',
+   'Manages patient scheduling, check-in/out, and basic billing. ' +
+   'Has limited clinical access (demographics only) and can fulfill GDPR data export requests. ' +
+   'Cannot process refunds or modify treatment plans.',
};
```

---

## Rationale

**Why This Change Is Necessary**:

1. **Legal Compliance**: GDPR Article 15 mandates data portability within 30 days
2. **Common Workflow**: Receptionists are first point of contact for patient requests
3. **Low Risk**: Export is sanitized and read-only (no sensitive clinical notes)
4. **Audit Trail**: All export events logged with requestor identity
5. **Identity Verification**: Practice policy requires patient identity verification before export

**Why This Is Safe**:

- Export endpoint returns sanitized patient data (demographics, appointment history, treatment summaries)
- Highly sensitive clinical notes (substance abuse, HIV status, mental health) are excluded from export
- Backend service enforces patient identity verification
- All exports are logged in audit trail with timestamp, requestor, and patient ID
- Export is READ-ONLY operation (no data modification)

---

## Testing Requirements

### Unit Tests

**File**: `/apps/backend-auth/test/unit/modules/rbac/role-permissions.spec.ts`

```typescript
describe('Receptionist Role', () => {
  it('should include clinical.records.export permission', () => {
    const permissions = getPermissionsForRole(SYSTEM_ROLES.RECEPTIONIST);
    expect(permissions).toContain(PERMISSIONS.CLINICAL.RECORDS.EXPORT);
  });

  it('should have 14 total permissions', () => {
    const permissions = getPermissionsForRole(SYSTEM_ROLES.RECEPTIONIST);
    expect(permissions).toHaveLength(14); // Was 13, now 14
  });
});
```

### Integration Tests

**File**: `/apps/backend-auth/test/integration/rbac/permission-checker.spec.ts`

```typescript
describe('Permission Checker - Clinical Records Export', () => {
  it('should allow receptionist to export patient records', async () => {
    const user = await createTestUser({
      roles: [SYSTEM_ROLES.RECEPTIONIST],
      tenantId: 'test-tenant',
    });

    const hasPermission = await permissionChecker.check(
      user,
      PERMISSIONS.CLINICAL.RECORDS.EXPORT,
    );

    expect(hasPermission).toBe(true);
  });

  it('should allow doctor to export patient records', async () => {
    const user = await createTestUser({
      roles: [SYSTEM_ROLES.DOCTOR],
      tenantId: 'test-tenant',
    });

    const hasPermission = await permissionChecker.check(
      user,
      PERMISSIONS.CLINICAL.RECORDS.EXPORT,
    );

    expect(hasPermission).toBe(true);
  });

  it('should deny assistant from exporting patient records', async () => {
    const user = await createTestUser({
      roles: [SYSTEM_ROLES.ASSISTANT],
      tenantId: 'test-tenant',
    });

    const hasPermission = await permissionChecker.check(
      user,
      PERMISSIONS.CLINICAL.RECORDS.EXPORT,
    );

    expect(hasPermission).toBe(false);
  });
});
```

### E2E Workflow Test

**File**: `/apps/backend-clinical/test/e2e/patient-records-export.e2e-spec.ts`

```typescript
describe('Patient Records Export (E2E)', () => {
  it('should allow receptionist to export patient records with valid verification', async () => {
    // Arrange: Create patient and records
    const patient = await createTestPatient({ tenantId: 'test-tenant' });
    const receptionist = await loginAs(SYSTEM_ROLES.RECEPTIONIST, 'test-tenant');

    // Act: Request export
    const response = await receptionist
      .post('/api/v1/clinical/records/export')
      .send({
        patientId: patient.id,
        verificationCode: 'VALID-CODE', // Identity verification
        format: 'pdf',
      });

    // Assert
    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('exportUrl');
    expect(response.body).toHaveProperty('expiresAt');

    // Verify audit log
    const auditLog = await getAuditLog({
      action: 'EXPORT_PATIENT_RECORDS',
      userId: receptionist.id,
      patientId: patient.id,
    });
    expect(auditLog).toBeDefined();
  });

  it('should deny export without valid patient verification', async () => {
    const patient = await createTestPatient({ tenantId: 'test-tenant' });
    const receptionist = await loginAs(SYSTEM_ROLES.RECEPTIONIST, 'test-tenant');

    const response = await receptionist
      .post('/api/v1/clinical/records/export')
      .send({
        patientId: patient.id,
        verificationCode: 'INVALID-CODE',
        format: 'pdf',
      });

    expect(response.status).toBe(403);
    expect(response.body.error).toMatch(/identity verification failed/i);
  });
});
```

---

## Documentation Updates Required

### 1. API Specification

**File**: `/apps/backend-clinical/docs/api-spec.yaml`

```yaml
/clinical/records/export:
  post:
    summary: Export patient clinical records (GDPR Article 15)
    security:
      - BearerAuth: []
    x-required-permissions:
      - clinical.records.export
    x-required-roles:
      - receptionist      # UPDATED - Added receptionist
      - doctor
      - tenant_admin
    parameters:
      - name: patientId
        in: body
        required: true
        schema:
          type: string
      - name: verificationCode
        in: body
        required: true
        description: Patient identity verification code (DOB, SSN last 4, etc.)
        schema:
          type: string
      - name: format
        in: body
        required: false
        schema:
          type: string
          enum: [pdf, json, ccda]
          default: pdf
    responses:
      200:
        description: Export generated successfully
        schema:
          type: object
          properties:
            exportUrl:
              type: string
              description: Temporary download URL (expires in 1 hour)
            expiresAt:
              type: string
              format: date-time
            requestId:
              type: string
              description: Audit trail reference
      403:
        description: Identity verification failed or permission denied
      429:
        description: Rate limit exceeded (max 5 exports per patient per day)
```

### 2. Role Documentation

**File**: `/apps/backend-auth/docs/RBAC-ROLES.md`

Update receptionist role description:

```markdown
### Receptionist Role

**Scope**: Clinic
**Typical Users**: Front desk staff, schedulers

**Capabilities**:
- Full appointment scheduling (create, update, cancel)
- Patient check-in/check-out
- Basic billing (create invoices, record payments)
- View patient demographic information
- Limited clinical access (view only)
- **NEW**: Fulfill GDPR data export requests with patient identity verification

**Restrictions**:
- Cannot access financial reports
- Cannot modify treatment plans
- Cannot process refunds (requires billing specialist or admin)
- Cannot diagnose or prescribe
```

### 3. GDPR Compliance Guide

**File**: `/docs/compliance/GDPR-COMPLIANCE.md`

```markdown
## GDPR Article 15: Right to Data Portability

### Workflow for Patient Data Export Requests

1. **Patient submits request** (verbal, email, or in-person)
2. **Receptionist verifies patient identity**:
   - Photo ID + Date of Birth
   - OR Last 4 of SSN + Home Address
   - OR Account PIN + Security Questions
3. **Receptionist generates export** via backend-clinical API:
   - POST `/api/v1/clinical/records/export`
   - Includes verification code
   - Selects format (PDF recommended for patients)
4. **System generates sanitized export**:
   - Demographics
   - Appointment history
   - Treatment summaries
   - Imaging (with patient consent)
   - Excludes: Sensitive clinical notes, internal staff comments
5. **Receptionist delivers export**:
   - Secure email (encrypted)
   - OR In-person pickup (printed and sealed)
6. **Audit log records event**:
   - Requestor identity
   - Patient identity
   - Verification method
   - Export format and delivery method

### Compliance Timeline
- **Response Time**: Within 30 days of request
- **Export Retention**: Download link expires after 24 hours
- **Rate Limiting**: Max 5 exports per patient per day (abuse prevention)
```

---

## Rollback Plan

If this change causes unexpected issues:

1. **Immediate Rollback** (if permission is exploited):
   ```diff
   - PERMISSIONS.CLINICAL.RECORDS.EXPORT, // Remove this line
   ```

2. **Alternative**: Add custom role with export permission
   ```typescript
   const PATIENT_SERVICES_COORDINATOR = {
     role: 'patient_services_coordinator',
     permissions: [
       ...RECEPTIONIST_PERMISSIONS,
       PERMISSIONS.CLINICAL.RECORDS.EXPORT,
     ],
   };
   ```

3. **Mitigation**: Add additional backend validation
   - Require manager approval for exports
   - Add two-factor authentication for export requests
   - Increase logging verbosity

---

## Approval Checklist

- [ ] Legal team reviewed GDPR compliance approach
- [ ] Security team approved permission addition
- [ ] Backend-clinical service implements identity verification
- [ ] Audit logging configured for all export events
- [ ] Rate limiting configured (max 5 exports/patient/day)
- [ ] Unit tests written and passing
- [ ] Integration tests written and passing
- [ ] E2E workflow test written and passing
- [ ] API documentation updated
- [ ] Role documentation updated
- [ ] GDPR compliance guide created
- [ ] Training materials prepared for receptionists

---

## Implementation Timeline

**Estimated Effort**: 4-6 hours

1. **Hour 1**: Code change + unit tests
2. **Hour 2**: Integration tests
3. **Hour 3**: E2E workflow test
4. **Hour 4**: Documentation updates
5. **Hour 5**: Training materials
6. **Hour 6**: Deployment and verification

**Target Completion**: Before AUTH-004 GROUP 2 sign-off

---

**Status**: READY FOR IMPLEMENTATION
**Priority**: HIGH
**Risk**: LOW (read-only operation with audit trail)
