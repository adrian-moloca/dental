/**
 * Clinical Page - Pagina Clinica pentru Pacient
 *
 * Main clinical module entry point showing odontogram, clinical notes,
 * procedures, and treatment plans for a specific patient.
 */

import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { AppShell } from '../components/layout/AppShell';
import { Card, CardHeader, CardBody } from '../components/ui-new/Card';
import { Button } from '../components/ui-new/Button';
import { Badge } from '../components/ui-new/Badge';
import { Breadcrumb, type BreadcrumbItem } from '../components/ui-new/Breadcrumb';
import { FloatingActionButton, type FABAction } from '../components/ui-new/FloatingActionButton';
import {
  Table,
  TableHead,
  TableBody,
  TableRow,
  TableHeaderCell,
  TableCell,
  TableEmpty,
} from '../components/ui-new/Table';
import {
  useClinicalNotes,
  useTreatmentPlans,
  useProcedures,
  useOdontogram,
  useUpdateOdontogram,
} from '../hooks/useClinical';
import { usePatient } from '../hooks/usePatients';
import { OdontogramEditor } from '../components/clinical/OdontogramEditor';
import { PatientContextBar } from '../components/clinical/PatientContextBar';
import { QuickActionsToolbar } from '../components/clinical/QuickActionsToolbar';
import clsx from 'clsx';
import toast from 'react-hot-toast';

type TabType = 'odontogram' | 'notes' | 'procedures' | 'plans';

// Extended patient interface to match backend response structure
interface PatientAlert {
  allergies?: Array<{ allergen: string; severity: string; reaction?: string }>;
  medicalConditions?: Array<{ condition: string; icd10Code?: string; status?: string }>;
}

interface ToothData {
  toothNumber: number;
  conditions: Array<{
    condition: string;
    surfaces: string[];
  }>;
}

export function ClinicalPage() {
  const { patientId } = useParams<{ patientId: string }>();
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<TabType>('odontogram');

  const handleBack = () => {
    if (window.history.length > 1) {
      navigate(-1);
    } else {
      navigate(`/patients/${patientId}`);
    }
  };

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      // Only trigger if Shift is pressed and no input is focused
      if (!e.shiftKey || (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement)) {
        return;
      }

      switch (e.key.toUpperCase()) {
        case 'N':
          e.preventDefault();
          setActiveTab('notes');
          toast.success('Shortcut: Note Clinice');
          break;
        case 'O':
          e.preventDefault();
          setActiveTab('odontogram');
          toast.success('Shortcut: Odontograma');
          break;
        case 'P':
          e.preventDefault();
          setActiveTab('procedures');
          toast.success('Shortcut: Proceduri');
          break;
        case 'T':
          e.preventDefault();
          setActiveTab('plans');
          toast.success('Shortcut: Planuri Tratament');
          break;
        case 'B':
          e.preventDefault();
          handleBack();
          break;
        case '?':
          e.preventDefault();
          toast.success('Comenzi rapide:\nShift+N: Note\nShift+O: Odontogram\nShift+P: Proceduri\nShift+T: Planuri\nShift+B: Inapoi', {
            duration: 6000
          });
          break;
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [navigate]);

  // Fetch patient data
  const { data: patientResponse, isLoading: patientLoading } = usePatient(patientId);
  const patient = patientResponse?.data;

  // Fetch clinical data
  const { data: notes, isLoading: notesLoading } = useClinicalNotes(patientId!);
  const { data: treatments, isLoading: treatmentsLoading } = useTreatmentPlans(patientId!);
  const { data: procedures, isLoading: proceduresLoading } = useProcedures(patientId!);
  const { data: odontogram, isLoading: odontogramLoading } = useOdontogram(patientId!);
  const updateOdontogram = useUpdateOdontogram();

  const handleSaveOdontogram = async (data: ToothData[]) => {
    await updateOdontogram.mutateAsync({
      patientId: patientId!,
      data: {
        patientId: patientId!,
        entries: [
          {
            chartedAt: new Date().toISOString(),
            teeth: data,
          },
        ],
      },
    });
  };

  const getPatientAge = () => {
    if (!patient?.dateOfBirth) return null;
    const birthDate = new Date(patient.dateOfBirth);
    const today = new Date();
    const age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      return age - 1;
    }
    return age;
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('ro-RO', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    });
  };

  const getPatientInitials = () => {
    if (!patient) return '?';
    const firstName = patient.firstName || '';
    const lastName = patient.lastName || '';
    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
  };

  const alertsCount = () => {
    // Cast to extended type with alerts field if it exists in the API response
    const patientWithAlerts = patient as typeof patient & { alerts?: PatientAlert };
    const allergies = patientWithAlerts?.alerts?.allergies?.length || 0;
    const conditions = patientWithAlerts?.alerts?.medicalConditions?.length || 0;
    return allergies + conditions;
  };

  // Tab definitions with shortcuts
  const tabs = [
    { id: 'odontogram' as TabType, label: 'Odontograma', icon: 'ti ti-dental', shortcut: 'Shift+O' },
    { id: 'notes' as TabType, label: 'Note Clinice', icon: 'ti ti-notes', shortcut: 'Shift+N' },
    { id: 'procedures' as TabType, label: 'Proceduri', icon: 'ti ti-clipboard-list', shortcut: 'Shift+P' },
    { id: 'plans' as TabType, label: 'Planuri Tratament', icon: 'ti ti-list-check', shortcut: 'Shift+T' },
  ];

  // Quick actions for common procedures
  const handleQuickProcedure = (procedureType: string) => {
    toast.success(`Adaugare rapida: ${procedureType}`, { icon: '⚡' });
    setActiveTab('procedures');
    // In production, this would open a modal or inline form
  };

  // Floating action button menu
  const fabActions: FABAction[] = [
    {
      id: 'add-note',
      label: 'Nota Clinica Noua',
      icon: 'ti ti-notes',
      color: 'primary',
      onClick: () => {
        setActiveTab('notes');
        toast.success('Sectiune Note Clinice activata');
      },
      shortcut: 'Shift+N',
    },
    {
      id: 'add-procedure',
      label: 'Procedura Rapida',
      icon: 'ti ti-dental',
      color: 'success',
      onClick: () => {
        setActiveTab('procedures');
        toast.success('Sectiune Proceduri activata');
      },
      shortcut: 'Shift+P',
    },
    {
      id: 'view-odontogram',
      label: 'Vizualizeaza Odontograma',
      icon: 'ti ti-dental',
      color: 'info',
      onClick: () => {
        setActiveTab('odontogram');
        toast.success('Odontograma activata');
      },
      shortcut: 'Shift+O',
    },
    {
      id: 'create-plan',
      label: 'Plan Tratament Nou',
      icon: 'ti ti-list-check',
      color: 'warning',
      onClick: () => {
        setActiveTab('plans');
        toast.success('Sectiune Planuri Tratament activata');
      },
      shortcut: 'Shift+T',
    },
    {
      id: 'view-xray',
      label: 'Radiografii',
      icon: 'ti ti-radiation',
      color: 'secondary',
      onClick: () => navigate(`/imaging/${patientId}`),
    },
  ];

  // Breadcrumb navigation
  const breadcrumbItems: BreadcrumbItem[] = [
    { label: 'Dashboard', href: '/dashboard', icon: 'ti ti-home' },
    { label: 'Pacienti', href: '/patients', icon: 'ti ti-users' },
    ...(patient ? [
      { label: `${patient.firstName} ${patient.lastName}`, href: `/patients/${patientId}`, icon: 'ti ti-user' }
    ] : []),
    { label: 'Date Clinice', icon: 'ti ti-dental' }
  ];

  // Page actions
  const pageActions = (
    <div className="d-flex gap-2">
      <Button
        variant="outline-secondary"
        icon="ti ti-arrow-left"
        onClick={handleBack}
        title="Inapoi (Shift+B)"
      >
        Inapoi
      </Button>
      <Button
        variant="outline-primary"
        icon="ti ti-printer"
        onClick={() => toast.info('Functionalitate in dezvoltare')}
      >
        Printeaza Fisa
      </Button>
      <Button
        variant="soft-info"
        icon="ti ti-keyboard"
        onClick={() => toast.success('Comenzi rapide:\nShift+N: Note\nShift+O: Odontogram\nShift+P: Proceduri\nShift+T: Planuri\nShift+B: Inapoi\nShift+?: Ajutor', {
          duration: 6000
        })}
        title="Vezi comenzile rapide (Shift+?)"
      >
        <i className="ti ti-keyboard"></i>
      </Button>
    </div>
  );

  if (patientLoading) {
    return (
      <AppShell>
        <div className="d-flex justify-content-center align-items-center" style={{ minHeight: '400px' }}>
          <div className="spinner-border text-primary" role="status">
            <span className="visually-hidden">Se incarca...</span>
          </div>
        </div>
      </AppShell>
    );
  }

  return (
    <AppShell
      title="Date Clinice"
      subtitle="Gestioneaza informatiile clinice ale pacientului"
      actions={pageActions}
    >
      {/* Breadcrumb Navigation */}
      <Breadcrumb items={breadcrumbItems} className="mb-3" />

      {/* Patient Context Bar - Sticky at top */}
      {patient && (
        <div className="mb-4">
          <PatientContextBar
            patient={{
              id: patient.id,
              firstName: patient.firstName || '',
              lastName: patient.lastName || '',
              dateOfBirth: patient.dateOfBirth,
              gender: patient.gender,
              alerts: patient.alerts as PatientAlert | undefined,
            }}
            quickStats={{
              lastVisit: procedures?.data?.[0]?.procedureDate,
              treatmentPlanStatus: treatments?.data?.length > 0 ? 'in_progress' : 'none',
              balance: 0, // Would come from billing service
            }}
            onAddNote={() => {
              setActiveTab('notes');
              toast.success('Sectiune Note Clinice activata');
            }}
            onCreateTreatmentPlan={() => {
              setActiveTab('plans');
              toast.success('Sectiune Planuri Tratament activata');
            }}
            onViewHistory={() => navigate(`/patients/${patientId}`)}
            onViewFinancials={() => navigate(`/billing?patientId=${patientId}`)}
            sticky={true}
          />
        </div>
      )}

      <div className="row">
        <div className="col-12">
          {/* Quick Actions Toolbar */}
          {activeTab === 'procedures' && (
            <div className="mb-4">
              <QuickActionsToolbar
                onAddExam={() => handleQuickProcedure('Examinare Clinica')}
                onAddCleaning={() => handleQuickProcedure('Detartraj')}
                onAddFilling={() => handleQuickProcedure('Plomba')}
                onAddExtraction={() => handleQuickProcedure('Extractie')}
                onAddRootCanal={() => handleQuickProcedure('Canal Radicular')}
                onAddCrown={() => handleQuickProcedure('Coroana')}
                onAddXray={() => navigate(`/imaging/${patientId}`)}
                onAddNote={() => setActiveTab('notes')}
              />
            </div>
          )}

          {/* Bootstrap Nav Tabs with Shortcuts */}
          <ul className="nav nav-tabs nav-tabs-bottom mb-4" role="tablist">
            {tabs.map((tab) => (
              <li key={tab.id} className="nav-item" role="presentation">
                <button
                  className={clsx('nav-link', { active: activeTab === tab.id })}
                  type="button"
                  role="tab"
                  onClick={() => setActiveTab(tab.id)}
                  title={`${tab.label} (${tab.shortcut})`}
                >
                  <i className={tab.icon}></i>
                  <span className="ms-2">{tab.label}</span>
                  {tab.shortcut && (
                    <kbd className="ms-2 small opacity-75 bg-light text-muted border px-2 py-1 rounded">
                      {tab.shortcut}
                    </kbd>
                  )}
                </button>
              </li>
            ))}
            {/* Help shortcut indicator */}
            <li className="nav-item ms-auto">
              <button
                className="nav-link text-muted"
                type="button"
                onClick={() => toast.success('Comenzi rapide:\nShift+N: Note\nShift+O: Odontogram\nShift+P: Proceduri\nShift+T: Planuri\nShift+B: Inapoi\nShift+?: Ajutor', {
                  duration: 6000
                })}
                title="Vezi toate comenzile rapide"
              >
                <i className="ti ti-keyboard"></i>
                <span className="ms-2 small">Shift+?</span>
              </button>
            </li>
          </ul>

          {/* Tab Content */}
          <div className="tab-content">
            {/* Odontogram Tab */}
            {activeTab === 'odontogram' && (
              <div className="tab-pane fade show active">
                <div className="row">
                  <div className="col-12">
                    <Card>
                      <CardHeader title="Odontograma" icon="ti ti-dental" />
                      <CardBody>
                        {odontogramLoading ? (
                          <div className="text-center py-5">
                            <div className="spinner-border text-primary" role="status">
                              <span className="visually-hidden">Se incarca...</span>
                            </div>
                          </div>
                        ) : (
                          <OdontogramEditor
                            patientId={patientId!}
                            data={(odontogram?.data?.entries?.[0]?.teeth as ToothData[]) || []}
                            onSave={handleSaveOdontogram}
                          />
                        )}
                      </CardBody>
                    </Card>
                  </div>
                </div>
              </div>
            )}

            {/* Clinical Notes Tab */}
            {activeTab === 'notes' && (
              <div className="tab-pane fade show active">
                <Card>
                  <CardHeader
                    title="Note Clinice"
                    icon="ti ti-notes"
                    actions={
                      <Button variant="primary" icon="ti ti-plus" size="sm">
                        Nota Noua
                      </Button>
                    }
                  />
                  <CardBody>
                    {notesLoading ? (
                      <div className="text-center py-5">
                        <div className="spinner-border text-primary" role="status">
                          <span className="visually-hidden">Se incarca...</span>
                        </div>
                      </div>
                    ) : !notes?.data || notes.data.length === 0 ? (
                      <TableEmpty
                        icon="ti ti-notes-off"
                        title="Nicio nota clinica"
                        description="Incepe sa documentezi consultatiile pacientului"
                        action={
                          <Button variant="primary" icon="ti ti-plus">
                            Creaza Prima Nota
                          </Button>
                        }
                      />
                    ) : (
                      <div className="d-flex flex-column gap-3">
                        {notes.data.map((note) => (
                          <Card key={note.id} className="border">
                            <CardBody>
                              <div className="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                  <h5 className="mb-1">{note.title || 'Nota Clinica'}</h5>
                                  <div className="d-flex gap-2 align-items-center text-muted small">
                                    <span>{formatDate(note.encounterDate)}</span>
                                    <span>•</span>
                                    <span className="text-capitalize">{note.type || 'SOAP'}</span>
                                    {note.providerId && (
                                      <>
                                        <span>•</span>
                                        <span>Dr. {note.providerId}</span>
                                      </>
                                    )}
                                  </div>
                                </div>
                                <div className="d-flex gap-2">
                                  {note.isFinalized && (
                                    <Badge variant="soft-info" size="sm">
                                      Finalizat
                                    </Badge>
                                  )}
                                  {note.isSigned && (
                                    <Badge variant="soft-success" size="sm">
                                      Semnat
                                    </Badge>
                                  )}
                                </div>
                              </div>

                              {note.soap && (
                                <div className="d-flex flex-column gap-3">
                                  {note.soap.subjective && (
                                    <div>
                                      <div className="text-uppercase text-muted small fw-semibold mb-1">
                                        Subiectiv
                                      </div>
                                      <p className="mb-0">{note.soap.subjective}</p>
                                    </div>
                                  )}
                                  {note.soap.objective && (
                                    <div>
                                      <div className="text-uppercase text-muted small fw-semibold mb-1">
                                        Obiectiv
                                      </div>
                                      <p className="mb-0">{note.soap.objective}</p>
                                    </div>
                                  )}
                                  {note.soap.assessment && (
                                    <div>
                                      <div className="text-uppercase text-muted small fw-semibold mb-1">
                                        Evaluare
                                      </div>
                                      <p className="mb-0">{note.soap.assessment}</p>
                                    </div>
                                  )}
                                  {note.soap.plan && (
                                    <div>
                                      <div className="text-uppercase text-muted small fw-semibold mb-1">
                                        Plan
                                      </div>
                                      <p className="mb-0">{note.soap.plan}</p>
                                    </div>
                                  )}
                                </div>
                              )}

                              {note.content && !note.soap && (
                                <p className="mb-0 text-pre-wrap">{note.content}</p>
                              )}
                            </CardBody>
                          </Card>
                        ))}
                      </div>
                    )}
                  </CardBody>
                </Card>
              </div>
            )}

            {/* Procedures Tab */}
            {activeTab === 'procedures' && (
              <div className="tab-pane fade show active">
                <Card>
                  <CardHeader
                    title="Proceduri"
                    icon="ti ti-clipboard-list"
                    actions={
                      <Button variant="primary" icon="ti ti-plus" size="sm">
                        Procedura Noua
                      </Button>
                    }
                  />
                  <CardBody>
                    {proceduresLoading ? (
                      <div className="text-center py-5">
                        <div className="spinner-border text-primary" role="status">
                          <span className="visually-hidden">Se incarca...</span>
                        </div>
                      </div>
                    ) : !procedures?.data || procedures.data.length === 0 ? (
                      <TableEmpty
                        icon="ti ti-clipboard-off"
                        title="Nicio procedura"
                        description="Procedurile vor aparea aici odata documentate"
                      />
                    ) : (
                      <Table hover>
                        <TableHead>
                          <TableRow>
                            <TableHeaderCell>Data</TableHeaderCell>
                            <TableHeaderCell>Cod</TableHeaderCell>
                            <TableHeaderCell>Descriere</TableHeaderCell>
                            <TableHeaderCell>Dinti</TableHeaderCell>
                            <TableHeaderCell>Furnizor</TableHeaderCell>
                            <TableHeaderCell>Status</TableHeaderCell>
                            <TableHeaderCell className="text-end">Pret</TableHeaderCell>
                          </TableRow>
                        </TableHead>
                        <TableBody>
                          {procedures.data.map((proc) => (
                            <TableRow key={proc.id}>
                              <TableCell>{formatDate(proc.procedureDate)}</TableCell>
                              <TableCell>
                                <code className="text-primary">{proc.code}</code>
                              </TableCell>
                              <TableCell>{proc.description}</TableCell>
                              <TableCell className="text-muted">
                                {proc.teeth?.join(', ') || '-'}
                              </TableCell>
                              <TableCell className="text-muted">
                                {proc.providerId ? `Dr. ${proc.providerId}` : '-'}
                              </TableCell>
                              <TableCell>
                                {proc.status === 'completed' && (
                                  <Badge variant="soft-success">Completat</Badge>
                                )}
                                {proc.status === 'in_progress' && (
                                  <Badge variant="soft-info">In Progres</Badge>
                                )}
                                {proc.status === 'planned' && (
                                  <Badge variant="soft-warning">Planificat</Badge>
                                )}
                              </TableCell>
                              <TableCell className="text-end fw-semibold">
                                {proc.fee ? `${proc.fee.toFixed(2)} RON` : '-'}
                              </TableCell>
                            </TableRow>
                          ))}
                        </TableBody>
                      </Table>
                    )}
                  </CardBody>
                </Card>
              </div>
            )}

            {/* Treatment Plans Tab */}
            {activeTab === 'plans' && (
              <div className="tab-pane fade show active">
                <Card>
                  <CardHeader
                    title="Planuri de Tratament"
                    icon="ti ti-list-check"
                    actions={
                      <Button variant="primary" icon="ti ti-plus" size="sm">
                        Plan Nou
                      </Button>
                    }
                  />
                  <CardBody>
                    {treatmentsLoading ? (
                      <div className="text-center py-5">
                        <div className="spinner-border text-primary" role="status">
                          <span className="visually-hidden">Se incarca...</span>
                        </div>
                      </div>
                    ) : !treatments?.data || treatments.data.length === 0 ? (
                      <TableEmpty
                        icon="ti ti-list-check-off"
                        title="Niciun plan de tratament"
                        description="Creaza planuri de tratament cu multiple optiuni"
                        action={
                          <Button variant="primary" icon="ti ti-plus">
                            Creaza Plan de Tratament
                          </Button>
                        }
                      />
                    ) : (
                      <div className="d-flex flex-column gap-3">
                        {treatments.data.map((plan) => (
                          <Card key={plan.id} className="border">
                            <CardBody>
                              <div className="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                  <h5 className="mb-1">{plan.title}</h5>
                                  <div className="text-muted small">
                                    {formatDate(plan.planDate)}
                                  </div>
                                </div>
                                <div>
                                  {plan.status === 'completed' && (
                                    <Badge variant="soft-success">Completat</Badge>
                                  )}
                                  {plan.status === 'in_progress' && (
                                    <Badge variant="soft-info">In Progres</Badge>
                                  )}
                                  {plan.status === 'approved' && (
                                    <Badge variant="soft-cyan">Aprobat</Badge>
                                  )}
                                  {plan.status === 'pending' && (
                                    <Badge variant="soft-warning">In Asteptare</Badge>
                                  )}
                                  {plan.status === 'draft' && (
                                    <Badge variant="soft-secondary">Ciorna</Badge>
                                  )}
                                </div>
                              </div>

                              {/* Plan Options/Phases */}
                              {plan.options && plan.options.length > 0 && (
                                <div className="d-flex flex-column gap-2">
                                  {plan.options.map((option) => (
                                    <div
                                      key={option.optionId}
                                      className="p-3 bg-light rounded border"
                                    >
                                      <div className="d-flex justify-content-between align-items-center mb-2">
                                        <span className="fw-semibold">{option.name}</span>
                                        <span className="text-primary fw-bold">
                                          {option.totalEstimatedCost.toFixed(2)} RON
                                        </span>
                                      </div>
                                      {option.procedures && option.procedures.length > 0 && (
                                        <div className="d-flex flex-column gap-1">
                                          {option.procedures.map((proc, idx) => (
                                            <div
                                              key={idx}
                                              className="d-flex justify-content-between text-muted small"
                                            >
                                              <span>{proc.description}</span>
                                              <span>{proc.estimatedCost.toFixed(2)} RON</span>
                                            </div>
                                          ))}
                                        </div>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              )}

                              {/* Plan Summary */}
                              {plan.options && plan.options.length > 0 && (
                                <div className="mt-2 text-muted small">
                                  <i className="ti ti-layers-linked me-1"></i>
                                  {plan.options.length} {plan.options.length === 1 ? 'Optiune' : 'Optiuni'}
                                </div>
                              )}
                            </CardBody>
                          </Card>
                        ))}
                      </div>
                    )}
                  </CardBody>
                </Card>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Floating Action Button for quick access */}
      <FloatingActionButton
        icon="ti ti-bolt"
        label="Actiuni Rapide"
        actions={fabActions}
        position="bottom-right"
        variant="primary"
        hideOnScroll={true}
      />
    </AppShell>
  );
}

export default ClinicalPage;
