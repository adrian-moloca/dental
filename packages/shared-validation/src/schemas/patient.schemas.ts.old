/**
 * Patient entity validation schemas
 * @module shared-validation/schemas/patient
 */

import { z } from 'zod';
import { ContactMethod } from '@dentalos/shared-types';
import {
  UUIDSchema,
  EmailSchema,
  PhoneNumberSchema,
  ISODateStringSchema,
  DateOnlySchema,
  NonEmptyStringSchema,
  GenderSchema,
  MaritalStatusSchema,
  ContactMethodSchema,
} from './common.schemas';
import { AddressSchema } from './tenant.schemas';

// ============================================================================
// Patient Demographics Schema
// ============================================================================

/**
 * Patient demographics schema
 */
export const PatientDemographicsSchema = z.object({
  firstName: NonEmptyStringSchema.max(100, 'First name must be 100 characters or less'),
  middleName: z.string().max(100, 'Middle name must be 100 characters or less').optional(),
  lastName: NonEmptyStringSchema.max(100, 'Last name must be 100 characters or less'),
  preferredName: z.string().max(100, 'Preferred name must be 100 characters or less').optional(),
  dateOfBirth: DateOnlySchema,
  gender: GenderSchema,
  maritalStatus: MaritalStatusSchema.optional(),
  socialSecurityNumber: z
    .string()
    .regex(/^\d{3}-\d{2}-\d{4}$/, 'Must be in format XXX-XX-XXXX')
    .optional(),
  language: z.string().max(50, 'Language must be 50 characters or less').default('en'),
  photoUrl: z.string().url('Must be a valid photo URL').optional(),
});

// ============================================================================
// Contact Information Schema
// ============================================================================

/**
 * Patient contact information schema
 */
export const PatientContactSchema = z.object({
  email: EmailSchema.optional(),
  phoneNumber: PhoneNumberSchema.optional(),
  mobileNumber: PhoneNumberSchema.optional(),
  workNumber: PhoneNumberSchema.optional(),
  preferredContactMethod: ContactMethodSchema.default(() => ContactMethod.EMAIL),
  address: AddressSchema.optional(),
});

// ============================================================================
// Emergency Contact Schema
// ============================================================================

/**
 * Emergency contact schema
 */
export const EmergencyContactSchema = z.object({
  name: NonEmptyStringSchema.max(200, 'Name must be 200 characters or less'),
  relationship: NonEmptyStringSchema.max(50, 'Relationship must be 50 characters or less'),
  phoneNumber: PhoneNumberSchema,
  alternatePhoneNumber: PhoneNumberSchema.optional(),
  email: EmailSchema.optional(),
});

// ============================================================================
// Insurance Information Schema
// ============================================================================

/**
 * Insurance information schema
 */
export const InsuranceInfoSchema = z.object({
  provider: NonEmptyStringSchema.max(200, 'Provider name must be 200 characters or less'),
  policyNumber: NonEmptyStringSchema.max(100, 'Policy number must be 100 characters or less'),
  groupNumber: z.string().max(100, 'Group number must be 100 characters or less').optional(),
  subscriberName: NonEmptyStringSchema.max(200, 'Subscriber name must be 200 characters or less'),
  subscriberRelationship: NonEmptyStringSchema.max(50, 'Relationship must be 50 characters or less'),
  subscriberDateOfBirth: DateOnlySchema.optional(),
  effectiveDate: DateOnlySchema.optional(),
  expirationDate: DateOnlySchema.optional(),
  isPrimary: z.boolean().default(true),
});

// ============================================================================
// Medical History Entry Schema
// ============================================================================

/**
 * Medical history entry schema
 */
export const MedicalHistoryEntrySchema = z.object({
  id: UUIDSchema,
  category: z.enum(['condition', 'allergy', 'medication', 'procedure', 'hospitalization'], {
    errorMap: (): { message: string } => ({ message: 'Invalid medical history category' }),
  }),
  description: NonEmptyStringSchema.max(500, 'Description must be 500 characters or less'),
  severity: z.enum(['mild', 'moderate', 'severe'], {
    errorMap: (): { message: string } => ({ message: 'Invalid severity' }),
  }).optional(),
  startDate: DateOnlySchema.optional(),
  endDate: DateOnlySchema.optional(),
  isCurrent: z.boolean().default(true),
  notes: z.string().max(1000, 'Notes must be 1000 characters or less').optional(),
  recordedAt: ISODateStringSchema,
  recordedBy: UUIDSchema,
});

// ============================================================================
// Dental History Schema
// ============================================================================

/**
 * Dental history schema
 */
export const DentalHistorySchema = z.object({
  lastDentalVisit: DateOnlySchema.optional(),
  lastCleaningDate: DateOnlySchema.optional(),
  lastXrayDate: DateOnlySchema.optional(),
  hasBraces: z.boolean().default(false),
  hasImplants: z.boolean().default(false),
  hasCrowns: z.boolean().default(false),
  grindsTeeth: z.boolean().default(false),
  bleedsWhenBrushing: z.boolean().default(false),
  sensitiveToCold: z.boolean().default(false),
  sensitiveToHot: z.boolean().default(false),
  sensitiveToSweets: z.boolean().default(false),
  notes: z.string().max(2000, 'Notes must be 2000 characters or less').optional(),
});

// ============================================================================
// Patient Schema
// ============================================================================

/**
 * Patient status schema
 */
export const PatientStatusSchema = z.enum(['active', 'inactive', 'archived', 'deceased'], {
  errorMap: (): { message: string } => ({ message: 'Invalid patient status' }),
});

/**
 * Complete patient entity schema
 */
export const PatientSchema = z.object({
  id: UUIDSchema,
  organizationId: UUIDSchema,
  clinicId: UUIDSchema,
  patientNumber: z.string().max(50, 'Patient number must be 50 characters or less'),
  demographics: PatientDemographicsSchema,
  contact: PatientContactSchema,
  emergencyContact: EmergencyContactSchema.optional(),
  insurance: z.array(InsuranceInfoSchema).default([]),
  medicalHistory: z.array(MedicalHistoryEntrySchema).default([]),
  dentalHistory: DentalHistorySchema.optional(),
  status: PatientStatusSchema.default('active'),
  assignedProviderId: UUIDSchema.optional(),
  referredBy: z.string().max(200, 'Referral source must be 200 characters or less').optional(),
  consentGiven: z.boolean().default(false),
  consentDate: ISODateStringSchema.optional(),
  privacyNoticeAccepted: z.boolean().default(false),
  privacyNoticeDate: ISODateStringSchema.optional(),
  tags: z.array(z.string().max(50, 'Tag must be 50 characters or less')).default([]),
  notes: z.string().max(5000, 'Notes must be 5000 characters or less').optional(),
  metadata: z.record(z.unknown()).optional(),
  createdAt: ISODateStringSchema,
  updatedAt: ISODateStringSchema,
  deletedAt: ISODateStringSchema.nullable().optional(),
  createdBy: UUIDSchema.optional(),
  updatedBy: UUIDSchema.optional(),
  deletedBy: UUIDSchema.nullable().optional(),
  version: z.number().int().nonnegative().default(1),
});

// ============================================================================
// Type Inference
// ============================================================================

export type PatientDemographicsInput = z.input<typeof PatientDemographicsSchema>;
export type PatientDemographicsOutput = z.output<typeof PatientDemographicsSchema>;
export type PatientContactInput = z.input<typeof PatientContactSchema>;
export type PatientContactOutput = z.output<typeof PatientContactSchema>;
export type EmergencyContactInput = z.input<typeof EmergencyContactSchema>;
export type EmergencyContactOutput = z.output<typeof EmergencyContactSchema>;
export type InsuranceInfoInput = z.input<typeof InsuranceInfoSchema>;
export type InsuranceInfoOutput = z.output<typeof InsuranceInfoSchema>;
export type MedicalHistoryEntryInput = z.input<typeof MedicalHistoryEntrySchema>;
export type MedicalHistoryEntryOutput = z.output<typeof MedicalHistoryEntrySchema>;
export type DentalHistoryInput = z.input<typeof DentalHistorySchema>;
export type DentalHistoryOutput = z.output<typeof DentalHistorySchema>;
export type PatientInput = z.input<typeof PatientSchema>;
export type PatientOutput = z.output<typeof PatientSchema>;
